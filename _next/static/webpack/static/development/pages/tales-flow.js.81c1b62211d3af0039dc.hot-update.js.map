{"version":3,"file":"static/webpack/static\\development\\pages\\tales-flow.js.81c1b62211d3af0039dc.hot-update.js","sources":["webpack:///./components/page-modules/talesFlow/TalesFlow.js"],"sourcesContent":["import React, { useState, useEffect, useCallback } from 'react'\r\nimport clsx from 'clsx'\r\nimport { makeStyles } from '@material-ui/core/styles'\r\nimport Box from '@material-ui/core/Box'\r\nimport _ from 'lodash'\r\nimport { connect } from 'react-redux'\r\nimport { startsWith } from '../../../utils/util'\r\nimport ControlPanel from './controlPanel/ControlPanel'\r\nimport JoyStick from './controlPanel/JoyStick'\r\nimport FlowST from './FlowST'\r\nimport FlowConnector from './FlowConnector'\r\nimport ModalEditChoice from './ModalEditChoice'\r\nimport FullScreenEdit from '../../common/modal/FullScreenEdit'\r\nimport { createFlowboard, getTransformStyle, createFlowConnectors } from './flowMaker'\r\nimport {\r\n    actionCreateNewTale,\r\n    actionCreateChoice,\r\n    actionUpdateCText\r\n} from '../../../redux/actionCreators/createTaleActions'\r\nimport {\r\n    FLOW_WIRE_SHIFT_X,\r\n    FLOW_WIRE_SHIFT_FROM_Y,\r\n    FLOW_WIRE_SHIFT_TO_Y,\r\n    FLOW_SPEED\r\n} from '../../../utils/constants'\r\nimport {\r\n    STORYLET_DELETE,\r\n    CHOICE_DELETE\r\n} from '../../../redux/actionTypes'\r\n\r\nconst useStyles = makeStyles(theme => ({\r\n    outerContainer: {\r\n        position: 'relative',\r\n        marginLeft: 35,\r\n        height: \"calc(100vh - 100px)\"\r\n    },\r\n    svgContainer: {\r\n        border: `7px double ${theme.palette.primary.main}`,\r\n        height: \"100%\",\r\n        overflow: \"auto\",\r\n        margin: `theme.spacing(1)px 0`,\r\n        borderRadius: theme.spacing(1)\r\n    },\r\n    mainSVG: {\r\n        height: 2000,\r\n        minWidth: \"100%\",\r\n        width: 2000,\r\n        \"-webkit-user-select\": \"none\",  /* Chrome all / Safari all */\r\n        \"-moz-user-select\": \"none\",     /* Firefox all */\r\n        \"-ms-user-select\": \"none\",      /* IE 10+ */\r\n        userSelect: \"none\",\r\n        borderRadius: 15,\r\n        \"& *\": {\r\n            \"-webkit-user-select\": \"none\",  /* Chrome all / Safari all */\r\n            \"-moz-user-select\": \"none\",     /* Firefox all */\r\n            \"-ms-user-select\": \"none\",      /* IE 10+ */\r\n            userSelect: \"none\"\r\n        }\r\n    },\r\n    joystick: {\r\n        position: \"absolute\",\r\n        bottom: 83,\r\n        left: 30\r\n    }\r\n}))\r\n\r\nconst TalesFlow = props => {\r\n    const classes = useStyles()\r\n    const { storylets, choices, start, history, createNewTale, deleteStorylet, deleteChoice, createNewChoice, updateChoiceText } = props\r\n    const [fb, setFb] = useState({})    // fb is flowboard object\r\n    const [fbC, setFbC] = useState({})  // fbC is flowboardConnectors object\r\n    const [isJStickVis, setJStickVis] = useState(false)\r\n    const [draggedStID, setDraggedStID] = useState('')\r\n    const [prevMPos, setPrevMPos] = useState({ x: 0, y: 0 })\r\n    const [selectedObj, setSelectedObj] = useState({id: '', type: ''})  // type will be \"ST\" or \"CH\" or \"IN\" or \"OUT\"\r\n    const [editChoiceData, setEditChoiceData] = useState({})\r\n    const [fseParam, setFSEParam] = useState({})    // Full Screen Edit    \r\n    const closeFSE = () => setFSEParam({})\r\n    // component is either a St or a Ch object\r\n    const openFSE = () => {\r\n        //console.log(component)\r\n        let component\r\n\r\n        if (!selectedObj.id || selectedObj.type==='IN' || selectedObj.type==='OUT') {\r\n            alert('Select a storylet or choice (connector) first. Then click on delete.')\r\n            return\r\n        }\r\n        else if(selectedObj.id[0] === 'S') component = storylets[selectedObj.id]\r\n        else if(selectedObj.id[0] === 'C') component = choices[selectedObj.id]\r\n\r\n        setFSEParam({\r\n            component, isVisible: true\r\n        })\r\n    }\r\n    /**\r\n     * flowBoard: {\r\n     *      stID1: {\r\n     *                  id: stID1,\r\n     *                  x: value,\r\n     *                  y: value,\r\n     *                  transformStyle: someCSSTransformStyle\r\n     *             },\r\n     *      stID2: {\r\n     *                  id: stID2,\r\n     *                  x: value,\r\n     *                  y: value,\r\n     *                  transformStyle: someCSSTransformStyle\r\n     *              }\r\n     * }\r\n     */\r\n    const paintFlowboard = useCallback(() => {\r\n        let flowBoard = createFlowboard(storylets, choices)\r\n        let flowConnectors = createFlowConnectors(storylets, choices, flowBoard)\r\n        // console.log(\"Inside paintFlowboard ............................. flowBoard = \", flowBoard)\r\n        setFb(flowBoard)\r\n        setFbC(flowConnectors)\r\n    }, [storylets, choices])\r\n\r\n    useEffect(() => {\r\n        //if a refresh is done on TalesFlow Page\r\n        // Then start creation process from here\r\n        if(!start) {\r\n            createNewTale()\r\n        }\r\n\r\n        paintFlowboard ()\r\n        \r\n    }, [createNewTale, start, paintFlowboard])\r\n\r\n    const handleSelection = (id, type) => {\r\n        // if prev selectedObj was 'out'\r\n        // and this is 'IN'\r\n        // Then create a choice (connection)\r\n        if (selectedObj.type === 'OUT' && type=== 'IN') {\r\n            let fromStID = selectedObj.id\r\n            let toStID = id\r\n            let ftid = fromStID + '---' + toStID\r\n\r\n            setEditChoiceData({\r\n                isOpen: true,\r\n                fromStID: fromStID,\r\n                toStID: toStID,\r\n                type: fbC[ftid] ? 'Edit' : 'Create',\r\n                text: fbC[ftid] ? choices[fbC[ftid].cid].text : ''\r\n            })\r\n            // if (fbC[ftid]) {\r\n            //     console.log('Connection already exists...')\r\n            // } else {\r\n            //     console.log(`Create connector from ${selectedObj.id} to ${id}`)\r\n            // }\r\n        }\r\n\r\n        // Now update the state\r\n        setSelectedObj({id, type})\r\n    }\r\n\r\n    const saveEditCreateChoice = (fromStID, toStID, text, type) => {\r\n        // is it create new\r\n        if (type === 'Create') {\r\n            createNewChoice(fromStID, toStID, text)\r\n        }\r\n        else if (type === 'Edit') {\r\n            let ftid = fromStID + '---' + toStID\r\n            let cID = fbC[ftid].cid\r\n            updateChoiceText(cID, text)\r\n        }\r\n        else {\r\n            console.log('Could not understand the type in saveEditCreateChoice')\r\n        }\r\n\r\n        setEditChoiceData({})\r\n    }\r\n\r\n    /**\r\n     * Whenever an ST is dragged/moved, we need to update the associated connectors\r\n     * @param {*} fbi => the updated flowboard item\r\n     */\r\n    const updateConnectors = fbi => {\r\n        let newFBC = {...fbC}\r\n        let wireShiftFTX = FLOW_WIRE_SHIFT_X\r\n        let wireShiftFY = FLOW_WIRE_SHIFT_FROM_Y\r\n        let wireShiftTY = FLOW_WIRE_SHIFT_TO_Y\r\n        // Go thru all the flowboard-Connectors\r\n        // to see with whom this stID is connected\r\n        for(let i in newFBC) {\r\n            let c = newFBC[i]\r\n            let ftidParts = c.id.split('---')   // id is basically ftid\r\n            let fromStID = ftidParts[0]\r\n            let toStID = ftidParts[1]\r\n\r\n            // if from id is this ST\r\n            if (fbi.id === fromStID) {\r\n                c = {...c}\r\n                c.x1 = fbi.x + wireShiftFTX\r\n                c.y1 = fbi.y + wireShiftFY\r\n\r\n                newFBC = {\r\n                    ...newFBC,\r\n                    [c.id]: c\r\n                }\r\n            }\r\n            // elseif to id is this ST\r\n            else if (fbi.id === toStID) {\r\n                c = {...c}\r\n                c.x2 = fbi.x + wireShiftFTX\r\n                c.y2 = fbi.y + wireShiftTY\r\n\r\n                newFBC = {\r\n                    ...newFBC,\r\n                    [c.id]: c\r\n                }\r\n            }\r\n        }\r\n\r\n        setFbC(newFBC)\r\n    }\r\n    \r\n    const markDraggedStID = (ev, stID) => {\r\n        ev.stopPropagation()\r\n        // console.log('setDraggedStID')\r\n        setDraggedStID(stID)\r\n        setPrevMPos({ x: ev.pageX,  y: ev.pageY })\r\n    }\r\n\r\n    const unmarkDraggedStID = ev => {\r\n        ev.stopPropagation()\r\n        // console.log('unsetDraggedStID')\r\n        setDraggedStID('')\r\n        setPrevMPos({ x: 0,  y: 0 })\r\n    }\r\n\r\n    const moveST = (stID, xDisplace, yDisplace) => {\r\n        if (!stID || !fb[stID]) return   // Important, don't remove\r\n        let prevElX = fb[stID].x\r\n        let prevElY = fb[stID].y\r\n        let newFBI = {\r\n            id: stID,\r\n            x: prevElX + xDisplace,\r\n            y: prevElY + yDisplace\r\n        }\r\n        newFBI.transformStyle = getTransformStyle(newFBI)\r\n        let newFB = {\r\n            ...fb,\r\n            [stID]: newFBI\r\n        }\r\n        setFb(newFB)\r\n\r\n        //ALSO NEED TO UPDATE THE CONNECTORS POSITION\r\n        updateConnectors(newFBI)\r\n    }\r\n\r\n    const moveDraggetST = _.throttle(ev => {\r\n        //ev.stopPropagation()\r\n        // console.log(\"moving 1\")\r\n        if (draggedStID) {\r\n            // console.log(\"moving 2\")\r\n            let mouseDiffX = ev.pageX - prevMPos.x\r\n            let mouseDiffY = ev.pageY - prevMPos.y\r\n            moveST(draggedStID, mouseDiffX, mouseDiffY)\r\n            setPrevMPos({ x: ev.pageX,  y: ev.pageY })\r\n        }\r\n    }, 1000)\r\n\r\n    const moveWithJStick = (xDisplace, yDisplace) => {\r\n        if (selectedObj.type === 'ST') {\r\n            moveST(selectedObj.id, xDisplace, yDisplace)\r\n        }\r\n    }\r\n\r\n    const moveLeft = () => moveWithJStick(-FLOW_SPEED, 0)\r\n    const moveRight = () => moveWithJStick(FLOW_SPEED, 0)\r\n    const moveUp = () => moveWithJStick(0, -FLOW_SPEED)\r\n    const moveDown = () => moveWithJStick(0, FLOW_SPEED)\r\n\r\n    const deleteComponent = () => {\r\n        if (!selectedObj.id || selectedObj.type==='IN' || selectedObj.type==='OUT') {\r\n            alert('Select a storylet or choice (connector) first. Then click on delete.')\r\n        }\r\n        else if(selectedObj.id === start) {\r\n            alert('Start storylet can not be deleted. Please edit it to your choice.')\r\n        }\r\n        else {\r\n            let comName = ''\r\n            if(selectedObj.id[0] === 'S') comName = 'STORYLET'\r\n            else if(selectedObj.id[0] === 'C') comName = 'CHOICE'\r\n            \r\n            if(typeof(window) === 'undefined') { console.log('Window undefined'); return}\r\n\r\n            let r = window.confirm(`Are you sure you want to delete ${comName} ${selectedObj.id}. Once deleted, it may not be recovered back.`)\r\n\r\n            if (r) {\r\n                if(comName === 'STORYLET') deleteStorylet(selectedObj.id)\r\n                else if (comName === 'CHOICE') deleteChoice(selectedObj.id)\r\n            }\r\n        }\r\n    }\r\n\r\n    // If props have changed, but useEffect has not updated flowboard yet\r\n    // stop the rendering\r\n    if (\r\n            Object.keys(storylets).length !== Object.keys(fb).length\r\n            ||\r\n            Object.keys(choices).length !== Object.keys(fbC).length\r\n        ) {\r\n        return (\r\n            <Box>\r\n                {/* {console.log('Stopping early rendering...')} */}\r\n                Updating ...\r\n            </Box>\r\n        )\r\n    }\r\n\r\n    // Else return\r\n    return (\r\n        <Box>\r\n            <ControlPanel \r\n                history={history} \r\n                deleteComponent={deleteComponent} \r\n                paintFlowboard={paintFlowboard}\r\n                toggleJStick={() => setJStickVis(!isJStickVis)}\r\n                openFSE={openFSE}\r\n            />\r\n\r\n            <div className={classes.outerContainer}>\r\n                <div className={classes.svgContainer} onClick={() => setSelectedObj({})}>\r\n                    <svg \r\n                        className={classes.mainSVG} \r\n                        onMouseUp={e => unmarkDraggedStID(e)}\r\n                    >\r\n                        {\r\n                            Object.values(fbC).map(c => \r\n                                <FlowConnector \r\n                                    c={c} key={c.id} \r\n                                    selectedObj={selectedObj}\r\n                                    handleSelection={handleSelection}\r\n                                />\r\n                            )\r\n                        }\r\n                        \r\n                        {\r\n                            //console.log(\"props.storylets\", storylets)\r\n                            Object.values(fb).map(fbi => {\r\n                                let st = storylets[fbi.id]\r\n                                return (<FlowST \r\n                                            stid={st.id} \r\n                                            title={st.title} \r\n                                            transformStyle={fbi.transformStyle}\r\n                                            start={start} \r\n                                            key={st.id}\r\n                                            selectedObj={selectedObj}\r\n                                            handleSelection={handleSelection}\r\n                                            handleMouseDown={markDraggedStID}\r\n                                            handleMouseUp={unmarkDraggedStID}\r\n                                            handleMouseMove={moveDraggetST}\r\n                                        />)\r\n                            })\r\n                        }\r\n                    </svg>\r\n                </div>\r\n\r\n                <div className={clsx(classes.joystick, !isJStickVis && 'hide')}>\r\n                    <JoyStick \r\n                        moveLeft={moveLeft}\r\n                        moveRight={moveRight}\r\n                        moveUp={moveUp}\r\n                        moveDown={moveDown}\r\n                    />\r\n                </div>\r\n            </div>\r\n        \r\n            <ModalEditChoice \r\n                isOpen={editChoiceData.isOpen} \r\n                {...editChoiceData}\r\n                handleClose={()=>setEditChoiceData({})}\r\n                handleSave={saveEditCreateChoice}\r\n            />\r\n\r\n            <FullScreenEdit \r\n                isOpen={fseParam.isVisible}\r\n                handleClose={closeFSE}\r\n                component={fseParam.component}\r\n            />\r\n        </Box>\r\n    )\r\n}\r\n\r\nconst mapStateToProps = state => ({\r\n    start: state.wipTale.start,\r\n    storylets: state.wipTale.storylets,\r\n    choices: state.wipTale.choices\r\n})\r\nconst mapDispatchToProps = dispatch => ({\r\n    createNewTale: () => dispatch(actionCreateNewTale()),\r\n    deleteStorylet: stID => dispatch({type: STORYLET_DELETE, payload: stID}),\r\n    deleteChoice: cID => dispatch({type: CHOICE_DELETE, payload: cID}),\r\n    createNewChoice: (fromStID, toStID, text) => dispatch(actionCreateChoice(fromStID, toStID, text)),\r\n    updateChoiceText: (cID, value) => dispatch(actionUpdateCText(cID, value))\r\n})\r\nexport default connect(mapStateToProps, mapDispatchToProps)(TalesFlow)"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAKA;AAMA;AAKA;AAAA;AACA;AACA;AACA;AACA;AAHA;AAKA;AACA;AACA;AACA;AACA;AACA;AALA;AAOA;AACA;AACA;AACA;AACA;AACA;AADA;AACA;AACA;AADA;AACA;AACA;AADA;AACA;AACA;AACA;AACA;AACA;AADA;AACA;AACA;AADA;AACA;AACA;AADA;AACA;AAJA;AATA;AAgBA;AACA;AACA;AACA;AAHA;AA7BA;AAAA;AACA;AAmCA;AACA;AADA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AADA;AAAA;AAAA;AACA;AACA;AAFA;AAAA;AAAA;AACA;AACA;AAFA;AAAA;AAAA;AACA;AADA;AAAA;AAAA;AACA;AADA;AAOA;AAAA;AAAA;AAPA;AAAA;AACA;AADA;AAQA;AAAA;AAAA;AARA;AAAA;AACA;AACA;AAFA;AAAA;AAAA;AACA;AADA;AAAA;AAAA;AACA;AACA;AASA;AAAA;AAAA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAGA;AACA;AAAA;AADA;AAGA;AACA;;;;;;;;;;;;;;;;;;AAgBA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AALA;AAQA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAEA;;;;;;AAIA;AACA;AACA;AAAA;AACA;AACA;AAEA;AACA;AAAA;AACA;AACA;AACA;AAAA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAIA;AATA;AAYA;AACA;AACA;AAEA;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AAHA;AAKA;AACA;AAAA;AACA;AAGA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AAGA;AACA;AACA;AADA;AAKA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAKA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AAAA;AAAA;AACA;AALA;AAAA;AAAA;AAAA;AAAA;AAAA;AAQA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AAAA;AAAA;AAFA;AAAA;AAAA;AAAA;AAAA;AAAA;AAKA;AAEA;AAAA;AACA;AACA;AAHA;AAAA;AAAA;AAAA;AAAA;AAAA;AADA;AAWA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAVA;AAAA;AAAA;AAAA;AAAA;AAAA;AAYA;AAKA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AAJA;AAAA;AAAA;AAAA;AAAA;AAAA;AAUA;AADA;AAGA;AAAA;AAAA;AACA;AAJA;AAAA;AAAA;AAAA;AAAA;AAAA;AAQA;AACA;AACA;AAHA;AAAA;AAAA;AAAA;AAAA;AAAA;AAOA;AACA;AACA;AAAA;AACA;AACA;AACA;AAHA;AAAA;AACA;AAIA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AALA;AAAA;AACA;AAMA;;;;A","sourceRoot":""}